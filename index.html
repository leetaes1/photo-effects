<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Pixel Stretcher</title>
    <style>
        :root {
            --sidebar-width: 340px;
            --bg-dark: #0f0f0f;
            --panel-bg: #1a1a1a;
            --accent: #3d5afe;
            --text-main: #f0f0f0;
            --text-dim: #999;
        }

        body {
            margin: 0; font-family: 'Segoe UI', Tahoma, sans-serif;
            background: var(--bg-dark); color: var(--text-main);
            display: flex; height: 100vh; overflow: hidden;
        }

        /* ì™¼ìª½ ì‚¬ì´ë“œë°” */
        .sidebar {
            width: var(--sidebar-width); background: var(--panel-bg);
            padding: 25px; box-sizing: border-box; display: flex;
            flex-direction: column; gap: 20px; overflow-y: auto;
            border-right: 1px solid #333; z-index: 100;
        }

        h2 { margin: 0 0 10px 0; font-size: 1.4rem; color: #fff; }
        .desc { font-size: 0.8rem; color: var(--text-dim); line-height: 1.5; }

        .control-item { display: flex; flex-direction: column; gap: 8px; }
        label { font-size: 0.85rem; font-weight: 500; display: flex; justify-content: space-between; }
        label span { color: var(--accent); }

        input[type="range"] { width: 100%; accent-color: var(--accent); cursor: pointer; }
        input[type="number"] { background: #222; border: 1px solid #444; color: #fff; padding: 5px; border-radius: 4px; }
        
        .checkbox-group { flex-direction: row; align-items: center; gap: 10px; font-size: 0.9rem; cursor: pointer; }

        .btn-group { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
        button {
            padding: 12px; border-radius: 6px; border: none; font-weight: bold;
            cursor: pointer; transition: 0.3s; font-size: 0.9rem;
        }
        .btn-upload { background: #333; color: white; border: 1px dashed #555; }
        .btn-process { background: var(--accent); color: white; }
        .btn-download { background: #2e7d32; color: white; }
        button:hover { filter: brightness(1.2); }

        /* ë©”ì¸ ì˜ì—­ */
        .canvas-area {
            flex: 1; display: flex; align-items: center; justify-content: center;
            background: #050505; position: relative; padding: 20px;
        }
        #canvas-container { position: relative; box-shadow: 0 0 40px rgba(0,0,0,0.8); }
        canvas { max-width: 100%; max-height: 90vh; display: block; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>Pixel Stretch</h2>
        <p class="desc">ì´ë¯¸ì§€ì˜ í”½ì…€ ë°ê¸°ë¥¼ ë¶„ì„í•˜ì—¬ ì˜ˆìˆ ì ì¸ ìŠ¤íŠ¸ë ˆì¹˜ íš¨ê³¼ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>

        <div class="control-item">
            <button class="btn-upload" onclick="document.getElementById('fileInput').click()">ğŸ“¤ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë ¤ë©´ í´ë¦­í•˜ì„¸ìš”</button>
            <input type="file" id="fileInput" hidden accept="image/*">
        </div>

        <div class="control-item">
            <label>ë°ê¸° í•˜í•œê°’ (Min) <span id="v-min">100</span></label>
            <input type="range" id="minBright" min="0" max="255" value="100">
        </div>

        <div class="control-item">
            <label>ìµœëŒ€ ë°ê¸° (Max) <span id="v-max">255</span></label>
            <input type="range" id="maxBright" min="0" max="255" value="255">
        </div>

        <div class="control-item">
            <label>ì˜ì—­ ìµœì†Œ í”½ì…€ (Min Area)</label>
            <input type="number" id="minArea" value="10" min="1">
        </div>

        <div class="control-item">
            <label>ìŠ¤íŠ¸ë¦½ ë„ˆë¹„ (px)</label>
            <input type="number" id="stripWidth" value="1" min="1" max="50">
        </div>

        <label class="checkbox-group">
            <input type="checkbox" id="showBox"> ê²½ê³„ ìƒì í‘œì‹œ (Debug)
        </label>

        <div class="btn-group">
            <button class="btn-process" id="processBtn">âš¡ ì´ë¯¸ì§€ ì²˜ë¦¬</button>
            <button id="resetBtn" style="background: #444; color: white;">ì´ˆê¸°í™”</button>
            <button class="btn-download" id="downloadBtn">ğŸ’¾ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</button>
        </div>

        <p class="desc" style="margin-top: 20px; border-top: 1px solid #333; pt: 10px;">
            ì°¸ê³ : ë°ê¸°ëŠ” $Y = 0.299R + 0.587G + 0.114B$ ê³µì‹ì„ ì‚¬ìš©í•˜ì—¬ ê³„ì‚°ë©ë‹ˆë‹¤.
        </p>
    </div>

    <div class="canvas-area">
        <div id="canvas-container">
            <canvas id="mainCanvas"></canvas>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const fileInput = document.getElementById('fileInput');
        
        let originalImg = null;

        // ìŠ¬ë¼ì´ë” ê°’ í‘œì‹œ
        document.querySelectorAll('input[type="range"]').forEach(input => {
            input.oninput = (e) => {
                document.getElementById('v-' + e.target.id.replace('Bright', '')).innerText = e.target.value;
            };
        });

        fileInput.onchange = (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const img = new Image();
                img.onload = () => {
                    originalImg = img;
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        };

        document.getElementById('resetBtn').onclick = () => {
            if(originalImg) ctx.drawImage(originalImg, 0, 0);
        };

        document.getElementById('processBtn').onclick = () => {
            if(!originalImg) return;
            
            // íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸°
            const minB = parseInt(document.getElementById('minBright').value);
            const maxB = parseInt(document.getElementById('maxBright').value);
            const minArea = parseInt(document.getElementById('minArea').value);
            const stripW = parseInt(document.getElementById('stripWidth').value);
            const showBox = document.getElementById('showBox').checked;

            const w = canvas.width;
            const h = canvas.height;
            
            // ì›ë³¸ ë°ì´í„°ë¡œ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            ctx.drawImage(originalImg, 0, 0);
            const imgData = ctx.getImageData(0, 0, w, h);
            const pixels = imgData.data;

            // ë¶„ì„ìš© ë°©ë¬¸ ì§€ë„
            const visited = new Uint8Array(w * h);
            const boxes = [];

            // 1. ì˜ì—­ ê²€ì¶œ (Flood Fill ë°©ì‹)
            for (let y = 0; y < h; y++) {
                for (let x = 0; x < w; x++) {
                    const idx = y * w + x;
                    if (visited[idx]) continue;

                    if (isTarget(pixels, idx * 4, minB, maxB)) {
                        const area = [];
                        const queue = [[x, y]];
                        visited[idx] = 1;

                        let minX = x, maxX = x, minY = y, maxY = y;

                        while(queue.length > 0) {
                            const [cx, cy] = queue.shift();
                            area.push([cx, cy]);

                            // 4ë°©í–¥ íƒìƒ‰
                            const neighbors = [[cx+1, cy], [cx-1, cy], [cx, cy+1], [cx, cy-1]];
                            for(const [nx, ny] of neighbors) {
                                if(nx >= 0 && nx < w && ny >= 0 && ny < h) {
                                    const nIdx = ny * w + nx;
                                    if(!visited[nIdx] && isTarget(pixels, nIdx * 4, minB, maxB)) {
                                        visited[nIdx] = 1;
                                        queue.push([nx, ny]);
                                        minX = Math.min(minX, nx); maxX = Math.max(maxX, nx);
                                        minY = Math.min(minY, ny); maxY = Math.max(maxY, ny);
                                    }
                                }
                            }
                        }

                        // ìµœì†Œ í”½ì…€ ê°œìˆ˜ ì¡°ê±´ í™•ì¸
                        if (area.length >= minArea) {
                            boxes.push({minX, maxX, minY, maxY});
                            // 2. ìŠ¤íŠ¸ë ˆì¹˜ ì ìš© (ì˜¤ë¥¸ìª½ìœ¼ë¡œ ëŠ˜ë¦¬ê¸° ì˜ˆì‹œ)
                            applyStretch(pixels, minX, minY, maxX, maxY, w, stripW);
                        }
                    }
                }
            }

            ctx.putImageData(imgData, 0, 0);

            // 3. ë””ë²„ê·¸ ë°•ìŠ¤ ê·¸ë¦¬ê¸°
            if (showBox) {
                ctx.strokeStyle = "cyan";
                ctx.lineWidth = 1;
                boxes.forEach(b => {
                    ctx.strokeRect(b.minX, b.minY, b.maxX - b.minX, b.maxY - b.minY);
                });
            }
        };

        function isTarget(data, i, min, max) {
            // ê³µì‹ ì ìš©: Y = 0.299R + 0.587G + 0.114B
            const brightness = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
            return brightness >= min && brightness <= max;
        }

        function applyStretch(data, minX, minY, maxX, maxY, canvasW, stripW) {
            // í•´ë‹¹ ì˜ì—­ì˜ ì„¸ë¡œ ì¤„ë§ˆë‹¤ ì²˜ë¦¬
            for (let y = minY; y <= maxY; y++) {
                // ìŠ¤íŠ¸ë¦½(ëŠ˜ë¦´ ì›ë³¸ í”½ì…€) ìœ„ì¹˜: ì˜ì—­ì˜ ì‹œì‘ì (minX)
                const sIdx = (y * canvasW + minX) * 4;
                const r = data[sIdx], g = data[sIdx+1], b = data[sIdx+2], a = data[sIdx+3];

                // ì˜ì—­ì˜ ë(maxX)ê¹Œì§€ ìŠ¤íŠ¸ë¦½ ë„ˆë¹„ë§Œí¼ ë°˜ë³µí•´ì„œ ì±„ì›€
                for (let x = minX; x < canvasW; x++) {
                    const tIdx = (y * canvasW + x) * 4;
                    data[tIdx] = r;
                    data[tIdx+1] = g;
                    data[tIdx+2] = b;
                    data[tIdx+3] = a;
                }
            }
        }

        document.getElementById('downloadBtn').onclick = () => {
            const link = document.createElement('a');
            link.download = 'pixel-art.png';
            link.href = canvas.toDataURL();
            link.click();
        };
    </script>
</body>
</html>
