<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Pixel Stretcher</title>
    <style>
        :root {
            --bg-color: #121212;
            --panel-color: #1e1e1e;
            --accent-color: #007aff;
            --text-color: #e0e0e0;
        }

        body {
            margin: 0;
            font-family: 'Inter', system-ui, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* 왼쪽 사이드바 설정 */
        .sidebar {
            width: 320px;
            background-color: var(--panel-color);
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
            z-index: 10;
        }

        h2 { font-size: 1.2rem; margin-top: 0; color: white; }
        
        .control-group {
            margin-bottom: 24px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        label { font-size: 0.85rem; color: #aaa; display: flex; justify-content: space-between; }
        
        input[type="range"] { width: 100%; cursor: pointer; }
        
        select, button {
            background: #333;
            border: 1px solid #444;
            color: white;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
        }

        button:hover { background: #444; }
        button.primary { background: var(--accent-color); border: none; font-weight: bold; margin-top: 10px; }
        button.primary:hover { background: #0063cc; }

        /* 메인 캔버스 영역 */
        .main-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            background-image: radial-gradient(#222 1px, transparent 1px);
            background-size: 20px 20px;
            position: relative;
        }

        #canvas-container {
            max-width: 100%;
            max-height: 100%;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            display: flex;
        }

        canvas {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
        }

        /* 업로드 버튼 스타일링 */
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        .file-input-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>Settings</h2>
        
        <div class="control-group">
            <label>Image Source</label>
            <div class="file-input-wrapper">
                <button style="width: 100%;">Upload Image</button>
                <input type="file" id="upload" accept="image/*">
            </div>
        </div>

        <hr style="width:100%; border:0; border-top:1px solid #333; margin: 10px 0 20px 0;">

        <div class="control-group">
            <label>Direction <span>방향</span></label>
            <select id="direction">
                <option value="right">Right (오른쪽으로)</option>
                <option value="left">Left (왼쪽으로)</option>
                <option value="down">Down (아래로)</option>
                <option value="up">Up (위로)</option>
            </select>
        </div>

        <div class="control-group">
            <label>Threshold Min <span id="minVal">100</span></label>
            <input type="range" id="thresholdMin" min="0" max="255" value="100">
        </div>

        <div class="control-group">
            <label>Threshold Max <span id="maxVal">255</span></label>
            <input type="range" id="thresholdMax" min="0" max="255" value="255">
        </div>

        <div class="control-group">
            <label>Strength (Repeat) <span>강도</span></label>
            <input type="range" id="strength" min="1" max="100" value="100">
        </div>

        <button id="processBtn" class="primary">Apply Effect</button>
        <button id="resetBtn">Reset Image</button>
        <button id="downloadBtn" style="margin-top: 50px; background: #28a745; border: none;">Download Result</button>
    </div>

    <div class="main-content">
        <div id="canvas-container">
            <canvas id="canvas"></canvas>
        </div>
    </div>

    <script>
        const upload = document.getElementById('upload');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        
        // UI Elements
        const tMin = document.getElementById('thresholdMin');
        const tMax = document.getElementById('thresholdMax');
        const direction = document.getElementById('direction');
        const strength = document.getElementById('strength');
        
        let originalImage = null;

        // 수치 실시간 표시
        tMin.oninput = () => document.getElementById('minVal').innerText = tMin.value;
        tMax.oninput = () => document.getElementById('maxVal').innerText = tMax.value;

        upload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    originalImage = img;
                    resetCanvas();
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        function resetCanvas() {
            if (!originalImage) return;
            canvas.width = originalImage.width;
            canvas.height = originalImage.height;
            ctx.drawImage(originalImage, 0, 0);
        }

        document.getElementById('resetBtn').onclick = resetCanvas;

        function runPixelStretch() {
            if (!originalImage) return;
            
            // 다시 원본을 그리고 시작
            resetCanvas();
            
            const w = canvas.width;
            const h = canvas.height;
            const imgData = ctx.getImageData(0, 0, w, h);
            const data = imgData.data;
            
            const min = parseInt(tMin.value);
            const max = parseInt(tMax.value);
            const dir = direction.value;
            const str = parseInt(strength.value) / 100; // 0~1 사이 비율

            if (dir === 'right' || dir === 'left') {
                for (let y = 0; y < h; y++) {
                    if (dir === 'right') {
                        for (let x = 0; x < w; x++) {
                            if (checkThreshold(data, (y * w + x) * 4, min, max)) {
                                stretchHorizontal(data, x, y, w, h, true, str);
                                break; 
                            }
                        }
                    } else {
                        for (let x = w - 1; x >= 0; x--) {
                            if (checkThreshold(data, (y * w + x) * 4, min, max)) {
                                stretchHorizontal(data, x, y, w, h, false, str);
                                break;
                            }
                        }
                    }
                }
            } else {
                for (let x = 0; x < w; x++) {
                    if (dir === 'down') {
                        for (let y = 0; y < h; y++) {
                            if (checkThreshold(data, (y * w + x) * 4, min, max)) {
                                stretchVertical(data, x, y, w, h, true, str);
                                break;
                            }
                        }
                    } else {
                        for (let y = h - 1; y >= 0; y--) {
                            if (checkThreshold(data, (y * w + x) * 4, min, max)) {
                                stretchVertical(data, x, y, w, h, false, str);
                                break;
                            }
                        }
                    }
                }
            }
            ctx.putImageData(imgData, 0, 0);
        }

        function checkThreshold(data, i, min, max) {
            const brightness = (data[i] + data[i+1] + data[i+2]) / 3;
            return brightness >= min && brightness <= max;
        }

        function stretchHorizontal(data, startX, y, w, h, isRight, str) {
            const i = (y * w + startX) * 4;
            const r = data[i], g = data[i+1], b = data[i+2], a = data[i+3];
            
            if (isRight) {
                const limit = startX + Math.floor((w - startX) * str);
                for (let x = startX; x < limit; x++) {
                    const idx = (y * w + x) * 4;
                    data[idx] = r; data[idx+1] = g; data[idx+2] = b; data[idx+3] = a;
                }
            } else {
                const limit = startX - Math.floor(startX * str);
                for (let x = startX; x >= limit; x--) {
                    const idx = (y * w + x) * 4;
                    data[idx] = r; data[idx+1] = g; data[idx+2] = b; data[idx+3] = a;
                }
            }
        }

        function stretchVertical(data, x, startY, w, h, isDown, str) {
            const i = (startY * w + x) * 4;
            const r = data[i], g = data[i+1], b = data[i+2], a = data[i+3];
            
            if (isDown) {
                const limit = startY + Math.floor((h - startY) * str);
                for (let y = startY; y < limit; y++) {
                    const idx = (y * w + x) * 4;
                    data[idx] = r; data[idx+1] = g; data[idx+2] = b; data[idx+3] = a;
                }
            } else {
                const limit = startY - Math.floor(startY * str);
                for (let y = startY; y >= limit; y--) {
                    const idx = (y * w + x) * 4;
                    data[idx] = r; data[idx+1] = g; data[idx+2] = b; data[idx+3] = a;
                }
            }
        }

        document.getElementById('processBtn').onclick = runPixelStretch;
        document.getElementById('downloadBtn').onclick = () => {
            const link = document.createElement('a');
            link.download = 'pixel-stretch-art.png';
            link.href = canvas.toDataURL();
            link.click();
        };
    </script>
</body>
</html>
